{% extends "base.html" %}
{% block title %}2FA Setup | SecureChain{% endblock %}
{% block content %}
<section class="mx-auto max-w-3xl rounded-3xl border border-emerald-400/25 bg-slate-900/60 p-8 shadow-glow backdrop-blur-xl">
    <div class="flex flex-wrap items-center justify-between gap-2">
        <h1 class="text-2xl font-bold text-emerald-200">Authenticator 2FA Setup</h1>
        {% if already_enabled %}
            <span class="rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 text-xs text-emerald-200">Already Enabled</span>
        {% endif %}
    </div>
    <p class="mt-2 text-sm text-slate-300">Scan the QR code in your authenticator app, then enter a verification code to activate 2FA.</p>

    <div class="mt-6 grid gap-6 md:grid-cols-2">
        <article class="rounded-2xl border border-slate-700/40 bg-slate-900/40 p-4">
            <p class="text-xs text-slate-400">Scan QR</p>
            <div class="mt-3 rounded-xl bg-white p-3">
                <img src="{{ qr_svg_data_uri }}" alt="2FA QR Code" class="mx-auto h-52 w-52" />
            </div>
        </article>
        <article class="rounded-2xl border border-slate-700/40 bg-slate-900/40 p-4 text-sm">
            <p class="text-xs text-slate-400">Manual setup key</p>
            <p class="mt-2 rounded-lg border border-emerald-400/30 bg-emerald-500/10 p-2 font-mono text-emerald-200">{{ pending_secret }}</p>
            <p class="mt-3 text-xs text-slate-400">Provisioning URI</p>
            <p class="mt-1 break-all rounded-lg border border-slate-700/40 bg-slate-900 p-2 font-mono text-[11px] text-slate-300">{{ provisioning_uri }}</p>
            <a href="{{ url_for('auth.setup_two_factor', rotate=1) }}" class="mt-3 inline-flex chip-link">Rotate Secret</a>
        </article>
    </div>

    <form method="POST" class="mt-6 grid gap-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="grid gap-1">
            <span class="text-sm text-slate-300">Enter 6-digit code to confirm</span>
            <input name="otp_code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="123456" required class="rounded-xl border border-slate-600 bg-slate-900/70 px-3 py-2 text-sm tracking-[0.3em] outline-none ring-emerald-300 focus:ring">
        </label>
        <button class="rounded-xl bg-emerald-400 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-emerald-300">Enable 2FA</button>
    </form>

    <div class="mt-5 flex flex-wrap gap-2">
        <a href="{{ url_for('main.profile_page', portal='admin' if session.get('role') == 'admin' else 'user') }}" class="chip-link">Back to Profile</a>
    </div>
</section>
{% endblock %}
