{% extends "base.html" %}
{% block title %}User Dashboard | SecureChain{% endblock %}
{% block content %}
<section class="mb-6 rounded-3xl border border-cyan-400/20 bg-slate-900/60 p-6 shadow-glow backdrop-blur-xl">
    <div class="grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2">
            <h1 class="text-2xl font-bold text-cyan-200 md:text-3xl">User Verification Workspace</h1>
            <p class="mt-2 text-sm text-slate-300">
                {% if is_self_dashboard %}
                    Welcome {{ dashboard_display_name }}. This workspace is focused on personal document verification, secure uploads, and ownership workflows.
                {% else %}
                    Viewing {{ dashboard_display_name }}'s dedicated dashboard in admin read-only mode.
                {% endif %}
            </p>
            <div class="mt-4 flex flex-wrap gap-3">
                <span class="inline-flex rounded-full border border-cyan-400/40 bg-cyan-500/10 px-3 py-1 font-mono text-xs text-cyan-200">
                    Chain: {{ "Healthy" if health.is_valid else "Alert" }}
                </span>
                <span class="inline-flex rounded-full border border-violet-400/40 bg-violet-500/10 px-3 py-1 font-mono text-xs text-violet-200">
                    Role: {{ dashboard_owner.role if dashboard_owner else session.role }}
                </span>
                <span class="inline-flex rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 font-mono text-xs text-emerald-200">
                    Dashboard ID: {{ dashboard_owner.user_id if dashboard_owner else session.user_id }}
                </span>
                {% if delegated_access_active %}
                    <span class="inline-flex rounded-full border border-violet-400/40 bg-violet-500/10 px-3 py-1 font-mono text-xs text-violet-200">
                        Delegated Admin: {{ delegated_scopes|join(', ') }} until {{ delegated_until[:19] if delegated_until else '-' }} UTC
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="rounded-2xl border border-slate-700/40 bg-slate-900/40 p-4">
            <h2 class="text-sm font-semibold text-slate-200">Blockchain Health Monitor</h2>
            <div class="mt-3 h-2 rounded-full bg-slate-700">
                <div class="h-2 rounded-full bg-gradient-to-r from-cyan-300 to-violet-300" style="width: {{ analytics.protection_score }}%"></div>
            </div>
            <p class="mt-2 text-xs text-slate-400">Protection Score: <span class="font-mono text-cyan-200">{{ analytics.protection_score }}%</span></p>
            <p class="mt-1 text-xs text-slate-400">Total Blocks: <span class="font-mono">{{ health.total_blocks }}</span></p>
            {% if not health.is_valid %}
                <p class="mt-2 text-xs text-rose-300">Integrity issues detected. Check blockchain explorer immediately.</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="grid gap-4 md:grid-cols-2 xl:grid-cols-7" id="stats-grid" data-dashboard-user="{{ dashboard_owner.user_id if dashboard_owner else session.user_id }}">
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Total Verified Files</p>
        <p class="mt-2 text-2xl font-bold text-cyan-200 stat-value" data-key="total_verified_files">{{ analytics.total_verified_files }}</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Protection Score</p>
        <p class="mt-2 text-2xl font-bold text-violet-300 stat-value" data-key="protection_score">{{ analytics.protection_score }}%</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Anomaly Score</p>
        <p class="mt-2 text-2xl font-bold text-fuchsia-300 stat-value" data-key="anomaly_score">{{ analytics.anomaly_score }}</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Open Incidents</p>
        <p class="mt-2 text-2xl font-bold text-rose-300 stat-value" data-key="open_incidents">{{ analytics.open_incidents }}</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">My Watchlist</p>
        <p class="mt-2 text-2xl font-bold text-violet-300 stat-value">{{ watchlist|length }}</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Open Review Requests</p>
        <p class="mt-2 text-2xl font-bold text-amber-300 stat-value">{{ open_review_requests }}</p>
    </article>
    <article class="glass-card skeleton stat-card">
        <p class="text-xs uppercase tracking-wide text-slate-400">Unread Alerts</p>
        <p class="mt-2 text-2xl font-bold text-cyan-200 stat-value">{{ unread_alerts }}</p>
    </article>
</section>

{% if admin_view %}
<section class="mb-6 rounded-2xl border border-amber-400/30 bg-amber-500/10 p-4 text-xs text-amber-100">
    You are viewing this user dashboard as admin. Interactive user actions are disabled in this view.
</section>
{% endif %}

<section id="batch-upload" class="mt-6 grid gap-6 xl:grid-cols-3">
    <article class="rounded-2xl border border-cyan-400/20 bg-slate-900/50 p-5 xl:col-span-2">
        <div class="flex flex-wrap items-center justify-between gap-2">
            <h2 class="text-lg font-semibold text-cyan-200">Secure Drive Upload (Admin Verification Required)</h2>
            <div class="flex flex-wrap gap-2">
                {% if is_self_dashboard %}
                    <a href="{{ url_for('main.export_portfolio_csv') }}" class="chip-link !border-emerald-400/30 !text-emerald-200">Export Portfolio CSV</a>
                {% endif %}
            </div>
        </div>
        <p class="mt-1 text-xs text-slate-400">Users upload to personal secure drive folders. Admin must approve each file before blockchain verification is created.</p>
        {% if is_self_dashboard %}
            <form method="POST" action="{{ url_for('main.upload_document') }}" enctype="multipart/form-data" class="mt-4 flex flex-wrap gap-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input name="folder" value="root" placeholder="Folder (e.g., legal/contracts/2026)" class="min-w-[220px] rounded-xl border border-slate-600 bg-slate-900/70 px-3 py-2 text-sm">
                <input
                    type="file"
                    name="document"
                    id="multi-upload-input"
                    multiple
                    required
                    class="flex-1 rounded-xl border border-slate-600 bg-slate-900/70 px-3 py-2 text-sm file:mr-3 file:rounded-lg file:border-0 file:bg-cyan-300 file:px-3 file:py-1 file:text-slate-900 file:font-semibold"
                    title="File is encrypted at rest and hashed before blockchain insertion."
                >
                <button type="button" id="upload-check-button" class="rounded-xl border border-violet-400/40 px-4 py-2 text-sm font-semibold text-violet-200 transition hover:bg-violet-500/20">
                    Upload Check
                </button>
                <button class="rounded-xl bg-cyan-400 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-cyan-300">
                    Batch Upload + Queue
                </button>
            </form>
        {% else %}
            <div class="mt-4 rounded-xl border border-slate-700/40 bg-slate-900/40 p-3 text-xs text-slate-400">
                Upload actions are available only on the owner's logged-in dashboard.
            </div>
        {% endif %}
        <p class="mt-2 text-[11px] text-slate-500">Daily quota from policy: {{ policy.max_daily_uploads_per_user }} successful uploads per account.</p>
        <div id="upload-check-results" class="mt-3 hidden rounded-xl border border-slate-700/40 bg-slate-900/40 p-3 text-xs"></div>

        <div class="mt-5 rounded-xl border border-violet-400/20 bg-violet-500/5 p-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <h3 class="text-sm font-semibold text-violet-200">My Secure Drive Queue</h3>
                <div class="flex flex-wrap gap-2 text-[11px]">
                    <span class="rounded-full bg-amber-500/20 px-2 py-1 text-amber-200">Pending: {{ pending_drive_count }}</span>
                    <span class="rounded-full bg-emerald-500/20 px-2 py-1 text-emerald-200">Approved: {{ approved_drive_count }}</span>
                    <span class="rounded-full bg-rose-500/20 px-2 py-1 text-rose-200">Rejected: {{ rejected_drive_count }}</span>
                </div>
            </div>
            <div class="mt-3 overflow-x-auto rounded-lg border border-slate-700/40">
                <table class="min-w-full text-left text-xs text-slate-200">
                    <thead class="bg-slate-800/70 text-[11px] uppercase text-slate-400">
                        <tr>
                            <th class="px-3 py-2">Drive ID</th>
                            <th class="px-3 py-2">Folder</th>
                            <th class="px-3 py-2">File</th>
                            <th class="px-3 py-2">Status</th>
                            <th class="px-3 py-2">Admin Note</th>
                            <th class="px-3 py-2">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700/50">
                        {% for item in drive_items %}
                            <tr class="hover:bg-slate-800/40">
                                <td class="px-3 py-2 font-mono text-violet-200">{{ item.drive_id }}</td>
                                <td class="px-3 py-2">{{ item.folder or "root" }}</td>
                                <td class="px-3 py-2">
                                    <p class="text-slate-300">{{ item.original_filename }}</p>
                                    <p class="text-[11px] text-slate-500">{{ item.uploaded_at[:19] }} UTC</p>
                                </td>
                                <td class="px-3 py-2">
                                    {% if item.status == 'pending' %}
                                        <span class="rounded-full bg-amber-500/20 px-2 py-1 text-[11px] text-amber-200">Pending Admin</span>
                                    {% elif item.status == 'approved' %}
                                        <span class="rounded-full bg-emerald-500/20 px-2 py-1 text-[11px] text-emerald-200">Approved</span>
                                    {% else %}
                                        <span class="rounded-full bg-rose-500/20 px-2 py-1 text-[11px] text-rose-200">Rejected</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-slate-400">{{ item.admin_note or "-" }}</td>
                                <td class="px-3 py-2">
                                    {% if item.status == 'approved' and item.verification_id %}
                                        <a href="{{ url_for('main.record_detail', verification_id=item.verification_id) }}" class="chip-link">Open Verified</a>
                                    {% elif item.status == 'pending' and is_self_dashboard %}
                                        <form method="POST" action="{{ url_for('main.delete_drive_item', drive_id=item.drive_id) }}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button class="chip-link !text-rose-200 !border-rose-400/30">Delete</button>
                                        </form>
                                    {% else %}
                                        <span class="text-slate-500">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="6" class="px-3 py-6 text-center text-slate-400">No drive uploads yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <h3 class="mt-5 text-sm font-semibold text-cyan-200">Verified Records Library</h3>
        <div class="mt-2 overflow-x-auto rounded-xl border border-slate-700/40">
            <table class="min-w-full text-left text-xs text-slate-200">
                <thead class="bg-slate-800/70 text-[11px] uppercase text-slate-400">
                    <tr>
                        <th class="px-3 py-2">Verification ID</th>
                        <th class="px-3 py-2">File</th>
                        <th class="px-3 py-2">Risk</th>
                        <th class="px-3 py-2">Status</th>
                        <th class="px-3 py-2">Version</th>
                        <th class="px-3 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700/50">
                    {% for r in records %}
                        {% set analysis = r.analysis %}
                        <tr class="hover:bg-slate-800/40">
                            <td class="px-3 py-2 font-mono text-cyan-200">{{ r.verification_id }}</td>
                            <td class="px-3 py-2">
                                <p class="font-medium">{{ r.original_filename }}</p>
                                <p class="text-[11px] text-slate-400">{{ r.uploaded_at[:19] }} UTC</p>
                            </td>
                            <td class="px-3 py-2">
                                {% if analysis.status == "complete" %}
                                    <span class="inline-flex rounded-full px-2 py-1 text-[11px]
                                        {% if analysis.fraud_indicator == "High" %}
                                            bg-rose-500/20 text-rose-200
                                        {% elif analysis.fraud_indicator == "Medium" %}
                                            bg-amber-500/20 text-amber-200
                                        {% else %}
                                            bg-emerald-500/20 text-emerald-200
                                        {% endif %}
                                    ">{{ analysis.fraud_indicator }} ({{ analysis.risk_percentage }}%)</span>
                                {% else %}
                                    <span class="inline-flex rounded-full bg-slate-700/60 px-2 py-1 text-[11px] text-slate-300">Processing</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2">
                                {% if r.status == "quarantined" %}
                                    <span class="rounded-full bg-amber-500/20 px-2 py-1 text-[11px] text-amber-200">Quarantined</span>
                                {% else %}
                                    <span class="rounded-full bg-emerald-500/20 px-2 py-1 text-[11px] text-emerald-200">Active</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2 text-slate-300">v{{ r.version }}</td>
                            <td class="px-3 py-2">
                                <div class="flex flex-wrap gap-2">
                                    <a href="{{ r.share_link }}" target="_blank" class="chip-link">Verify</a>
                                    <a href="{{ url_for('main.download_report', verification_id=r.verification_id) }}" class="chip-link">Report</a>
                                    <a href="{{ url_for('main.download_certificate', verification_id=r.verification_id) }}" class="chip-link">Certificate</a>
                                    <a href="{{ url_for('main.record_detail', verification_id=r.verification_id) }}" class="chip-link">Details</a>
                                    {% if is_self_dashboard %}
                                        {% if r.verification_id in watchlist_ids %}
                                            <form method="POST" action="{{ url_for('main.watchlist_remove', verification_id=r.verification_id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button class="chip-link !text-rose-200 !border-rose-400/30">Unwatch</button>
                                            </form>
                                        {% else %}
                                            <form method="POST" action="{{ url_for('main.watchlist_add', verification_id=r.verification_id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button class="chip-link !text-violet-200 !border-violet-400/30">Watch</button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        <tr class="bg-slate-900/40">
                            <td colspan="6" class="px-3 py-3">
                                <div class="grid gap-2 md:grid-cols-3">
                                    <div class="text-[11px] text-slate-400">
                                        Share link:
                                        <a class="text-cyan-300" href="{{ r.share_link }}" target="_blank">{{ r.share_link }}</a>
                                    </div>
                                    <div class="text-[11px] text-slate-400">Hash: <span class="font-mono">{{ r.file_hash[:18] }}...</span></div>
                                    <div class="text-[11px] text-slate-400 flex items-center gap-2">
                                        QR:
                                        <img src="{{ url_for('static', filename=r.qr_path) }}" alt="QR" class="h-10 w-10 rounded border border-slate-700">
                                    </div>
                                </div>
                                {% if is_self_dashboard and (session.role == 'admin' or r.owner_id == session.user_id) %}
                                    <details class="mt-2 rounded-lg border border-slate-700/40 bg-slate-900/40 p-2">
                                        <summary class="cursor-pointer text-xs text-violet-200">Transfer Ownership Record</summary>
                                        <form method="POST" action="{{ url_for('main.transfer_record', verification_id=r.verification_id) }}" class="mt-2 flex flex-wrap gap-2">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input name="target_username" placeholder="Target username" required class="rounded-lg border border-slate-600 bg-slate-900 px-2 py-1 text-xs">
                                            <input name="note" placeholder="Transfer note (optional)" class="rounded-lg border border-slate-600 bg-slate-900 px-2 py-1 text-xs">
                                            <button class="rounded-lg bg-violet-400 px-3 py-1 text-xs font-semibold text-slate-900">Transfer</button>
                                        </form>
                                    </details>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="px-3 py-8 text-center text-sm text-slate-400">
                                No records yet. Upload your first file to create blockchain-backed verification.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </article>

    <article class="rounded-2xl border border-violet-400/20 bg-slate-900/50 p-5">
        <h2 class="text-lg font-semibold text-fuchsia-200">Threat Intelligence Snapshot</h2>
        <p class="mt-1 text-xs text-slate-400">AI behavior insights and posture scoring.</p>
        <div class="mt-3 grid gap-2 text-xs">
            <div class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3">
                <p class="text-slate-400">Security Posture</p>
                <p class="text-lg font-bold text-fuchsia-200">{{ snapshot.posture_index }} <span class="text-sm">({{ snapshot.posture_grade }})</span></p>
            </div>
            <div class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3">
                <p class="text-slate-400">Risk Distribution</p>
                <p class="text-rose-300">High: {{ snapshot.risk_distribution.high }}</p>
                <p class="text-amber-300">Medium: {{ snapshot.risk_distribution.medium }}</p>
                <p class="text-emerald-300">Low: {{ snapshot.risk_distribution.low }}</p>
            </div>
        </div>
        <h2 class="mt-5 text-lg font-semibold text-violet-200">Live Activity Feed</h2>
        <p class="mt-1 text-xs text-slate-400">Real-time security and verification events.</p>
        <ul id="activity-feed" class="mt-4 space-y-2 text-xs">
            {% for activity in activities %}
                <li class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3">
                    <p class="font-mono text-slate-300">{{ activity.timestamp[:19] }} UTC</p>
                    <p class="mt-1 text-cyan-200">{{ activity.action }} <span class="text-slate-400">({{ activity.status }})</span></p>
                    <p class="text-slate-400">{{ activity.details }}</p>
                </li>
            {% else %}
                <li class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3 text-slate-400">No activity logs yet.</li>
            {% endfor %}
        </ul>
        <div class="mt-5 rounded-xl border border-cyan-400/20 bg-cyan-500/5 p-3">
            <div class="mb-2 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-cyan-200">Notification Center</h3>
                {% if is_self_dashboard %}
                    <button id="mark-alerts-read" class="chip-link">Mark Read</button>
                {% else %}
                    <span class="text-[11px] text-slate-500">Read-only</span>
                {% endif %}
            </div>
            <ul id="alerts-feed" class="space-y-2 text-xs">
                {% for alert in alerts %}
                    <li class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2">
                        <p class="text-slate-300">{{ alert.title }} <span class="text-slate-500">({{ alert.severity }})</span></p>
                        <p class="text-slate-400">{{ alert.message }}</p>
                    </li>
                {% else %}
                    <li class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-400">No alerts.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="mt-5 rounded-xl border border-fuchsia-400/20 bg-fuchsia-500/5 p-3">
            <div class="mb-2 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-fuchsia-200">Incident Queue</h3>
                {% if session.role == 'admin' %}
                    <a href="{{ url_for('main.integrity_center') }}" class="chip-link">Integrity Center</a>
                {% endif %}
            </div>
            {% if latest_scan %}
                <p class="text-[11px] text-slate-400 mb-2">
                    Last scan: {{ latest_scan.run_at[:19] }} UTC | Failed:
                    <span class="font-mono text-rose-300">{{ latest_scan.failed_records }}</span>
                </p>
            {% else %}
                <p class="text-[11px] text-slate-500 mb-2">No integrity scans yet.</p>
            {% endif %}
            <ul class="space-y-2 text-xs">
                {% for incident in incidents %}
                    <li class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2">
                        <p class="font-mono text-fuchsia-200">{{ incident.incident_id }} | {{ incident.severity|upper }}</p>
                        <p class="text-slate-300">{{ incident.title }}</p>
                        <p class="text-slate-500">{{ incident.status }} | VID {{ incident.verification_id }}</p>
                    </li>
                {% else %}
                    <li class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-400">No incidents created.</li>
                {% endfor %}
            </ul>
        </div>
    </article>
</section>

{% if delegated_access_active and is_self_dashboard %}
<section class="mt-6 rounded-2xl border border-violet-400/20 bg-violet-500/5 p-4 text-xs">
    <div class="flex flex-wrap items-center justify-between gap-2">
        <p class="text-violet-200">Delegated Admin Workspace Enabled</p>
        <p class="text-slate-400">Approved by {{ delegated_by or "admin" }}</p>
    </div>
    <p class="mt-1 text-slate-400">You can perform selected admin tasks under manager-approved delegation.</p>
    <div class="mt-2 flex flex-wrap gap-2">
        {% if 'verify_batch' in delegated_scopes %}
            <a href="{{ url_for('main.batch_verify') }}" class="chip-link !text-amber-200 !border-amber-400/30">Run Batch Verify</a>
        {% endif %}
        {% if 'compare_lab' in delegated_scopes %}
            <a href="{{ url_for('main.compare_records') }}" class="chip-link !text-violet-200 !border-violet-400/30">Open Compare Lab</a>
        {% endif %}
        <a href="{{ url_for('main.profile_page', portal='admin' if admin_view else 'user') }}" class="chip-link">Profile / Manual 2FA Review</a>
    </div>
</section>
{% endif %}

<section class="mt-6 grid gap-6 xl:grid-cols-2">
    <article class="rounded-2xl border border-violet-400/20 bg-slate-900/50 p-5">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-violet-200">My Watchlist</h2>
            <span class="text-[11px] text-slate-500">Compare Lab: {{ "Delegated" if delegated_access_active and 'compare_lab' in delegated_scopes else "Admin SOC only" }}</span>
        </div>
        <p class="mt-1 text-xs text-slate-400">Track high-priority verification IDs and quickly remove/archive entries.</p>
        <div class="mt-4 space-y-2 text-xs">
            {% for item in watchlist %}
                <div class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <p class="font-mono text-violet-200">{{ item.verification_id }} | {{ item.risk_percentage }}%</p>
                        <form method="POST" action="{{ url_for('main.watchlist_remove', verification_id=item.verification_id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button class="chip-link !text-rose-200 !border-rose-400/30">Remove</button>
                        </form>
                    </div>
                    <p class="text-slate-300">{{ item.original_filename }}</p>
                    <p class="text-slate-500">{{ item.note }} | {{ item.created_at[:19] }} UTC</p>
                    <a href="{{ url_for('main.record_detail', verification_id=item.verification_id) }}" class="mt-2 inline-flex chip-link">View Record</a>
                </div>
            {% else %}
                <p class="text-slate-400">No watchlist records yet. Add from record detail pages.</p>
            {% endfor %}
        </div>
    </article>

    <article class="rounded-2xl border border-cyan-400/20 bg-slate-900/50 p-5">
        <h2 class="text-lg font-semibold text-cyan-200">User Security Preferences</h2>
        <p class="mt-1 text-xs text-slate-400">Tune alerting, digest behavior, and AI copilot response style for this account.</p>
        {% if is_self_dashboard %}
            <form method="POST" action="{{ url_for('main.update_preferences') }}" class="mt-4 grid gap-3 text-xs">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="inline-flex items-center gap-2 text-slate-300">
                    <input type="checkbox" name="email_alerts" {% if user_preferences.email_alerts == '1' %}checked{% endif %}>
                    Enable email-alert simulation for high-risk events
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="text-slate-400">Digest Hour (UTC)</label>
                    <input name="digest_hour_utc" type="number" min="0" max="23" value="{{ user_preferences.digest_hour_utc }}" class="rounded-lg border border-slate-600 bg-slate-900 px-2 py-1">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <label class="text-slate-400">Risk Notify Minimum (%)</label>
                    <input name="risk_notify_min" type="number" min="1" max="99" value="{{ user_preferences.risk_notify_min }}" class="rounded-lg border border-slate-600 bg-slate-900 px-2 py-1">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <label class="text-slate-400">AI Copilot Mode</label>
                    <select name="chatbot_mode" class="rounded-lg border border-slate-600 bg-slate-900 px-2 py-1">
                        <option value="assistive" {% if user_preferences.chatbot_mode == 'assistive' %}selected{% endif %}>Assistive</option>
                        <option value="strict" {% if user_preferences.chatbot_mode == 'strict' %}selected{% endif %}>Strict Compliance</option>
                        <option value="concise" {% if user_preferences.chatbot_mode == 'concise' %}selected{% endif %}>Concise</option>
                    </select>
                </div>
                <button class="mt-1 rounded-lg bg-cyan-400 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-cyan-300">Save Preferences</button>
            </form>
        {% else %}
            <div class="mt-4 rounded-xl border border-slate-700/40 bg-slate-900/40 p-3 text-xs text-slate-400">
                Preferences can only be edited by the account owner.
            </div>
        {% endif %}
    </article>
</section>

<section class="mt-6 rounded-2xl border border-amber-400/20 bg-slate-900/50 p-5">
    <div class="flex flex-wrap items-center justify-between gap-2">
        <h2 class="text-lg font-semibold text-amber-200">My Review Requests</h2>
        <span class="rounded-full bg-amber-500/20 px-2 py-1 text-[11px] text-amber-200">Open: {{ open_review_requests }}</span>
    </div>
    <p class="mt-1 text-xs text-slate-400">Track requests submitted for quarantined document release and admin decisions.</p>
    <div class="mt-4 grid gap-2 md:grid-cols-2 xl:grid-cols-3 text-xs">
        {% for request in review_requests %}
            <div class="rounded-xl border border-slate-700/40 bg-slate-900/40 p-3">
                <div class="flex items-center justify-between gap-2">
                    <p class="font-mono text-amber-200">{{ request.request_id }}</p>
                    <span class="rounded-full px-2 py-1 text-[10px]
                        {% if request.status == 'open' %}
                            bg-amber-500/20 text-amber-200
                        {% elif request.status == 'approved' %}
                            bg-emerald-500/20 text-emerald-200
                        {% else %}
                            bg-rose-500/20 text-rose-200
                        {% endif %}
                    ">{{ request.status }}</span>
                </div>
                <p class="mt-1 text-slate-300">VID {{ request.verification_id }}</p>
                <p class="text-slate-400">{{ request.reason }}</p>
                {% if request.admin_note %}
                    <p class="text-slate-500">Admin note: {{ request.admin_note }}</p>
                {% endif %}
                <a href="{{ url_for('main.record_detail', verification_id=request.verification_id) }}" class="mt-2 inline-flex chip-link">Open Record</a>
            </div>
        {% else %}
            <p class="text-slate-400">No review requests submitted yet.</p>
        {% endfor %}
    </div>
</section>

<section class="mt-6 rounded-2xl border border-emerald-400/20 bg-slate-900/50 p-5">
    <div class="flex flex-wrap items-center justify-between gap-2">
        <h2 class="text-lg font-semibold text-emerald-200">Encrypted Personal Profile</h2>
        {% if is_self_dashboard %}
            <a href="{{ url_for('main.profile_page', portal='admin' if admin_view else 'user') }}" class="chip-link !text-emerald-200 !border-emerald-400/30">Open Profile Page</a>
        {% endif %}
    </div>
    <p class="mt-1 text-xs text-slate-400">Your profile is encrypted at rest with platform security keys.</p>
    {% if is_self_dashboard %}
        <div class="mt-4 rounded-xl border border-slate-700/40 bg-slate-900/40 p-3 text-xs text-slate-300">
            Manage your full profile in a dedicated page with view and edit mode. Changes are saved in encrypted storage.
        </div>
    {% else %}
        <div class="mt-4 grid gap-2 text-xs md:grid-cols-2">
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Name: {{ profile_data.full_name or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Email: {{ profile_data.email_contact or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Phone: {{ profile_data.phone or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Organization: {{ profile_data.organization or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Designation: {{ profile_data.designation or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300">Identity ID: {{ profile_data.gov_id or "-" }}</div>
            <div class="rounded-lg border border-slate-700/40 bg-slate-900/40 p-2 text-slate-300 md:col-span-2">Address: {{ profile_data.address or "-" }}</div>
        </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
    window.SecureChain = window.SecureChain || {};
    window.SecureChain.dashboard = true;
</script>
{% endblock %}
